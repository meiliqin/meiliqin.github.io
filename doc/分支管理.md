# 新发布流程分支管理规范



**包体定义**

- 灰度包：每周直接从Develop分支输出，用于灰度上线，仅灰度用户可更新使用。
- 正式包：包体在前两周的灰度包中进行MTL和全回归，发布的正式版本。
- 额外正式包：针对特殊紧急需求发布的正式版本。

**版本号区分**

- 正式版本：末位为0，如2.2.0
- 灰度版本：末位不为0，如2.2.1

**App内升级**

- 升级弹窗隔离：正式用户只收到正式版升级弹窗，灰度用户只收到灰度版升级弹窗。
- 灰度用户挑选：正式用户可以收到灰度弹窗（支持abt分流），可以通过接受灰度邀请成为灰度用户，灰度用户不再接收到灰度弹窗。
- 升级弹窗：APP配置针对灰度客户端增加一种beta_update的弹窗配置。

**分支管理**

- develop分支：作为灰度版本和正式版本发布的基线，发布操作都从这里开始；另外也可作为功能合并之后（打灰度包之前）的bug修复；
- feature分支：功能开发分支，根据功能命名，如feature/app_update；
  - 创建：所有的feature分支需要从最近的tag出拉出，不能直接从develop拉分支，避免需求交叉；
  - 合并：确定该需求是在当前的灰度版本发布并测试完成达到上线标准后再合并到develop分支；
- bugfix分支：灰度包bug修复分支，根据对应已发布的灰度版本命名，如bugfix/2.2.0;
  - 创建：每发布一个灰度包后，从该灰度包的tag处创建bugfix分支，用于该灰度包的bug修复；
  - 合并：如果该灰度包不对外发布，则直接将修复并测试ok的代码合并到develop；如果需要基于该灰度包发布正式包，则参考release分支的创建和合并流程；
- release分支：正式包发布分支，在此分支上MTL和回归，以发布版本号命名，如release/2.2.0；
  - 创建：基于可发布灰度包的bugfix分支创建；
  - 合并：完成正式包发布流程之后将该分支合并到master并打上tag，然后再将master合并到develop；
- revert分支：功能回滚分支，此分支用作功能回滚测试，根据功能命名，如revert/circle_update；
  - 创建：基于需要回滚的功能分支创建；
  - 合并：回滚经过QA测试之后，分支分别合并到release进行发布，并且同步develop；
- hotfix分支：热修复分支，此分支用于修复线上问题，使用热修复插件完成修复，以修复版本命名，如hotfix/2.2.0_1
  - 创建：基于release分支对应的tag创建需要进行hotfix patch打包的分支；
  - 合并：patch发布之后，将修改合并到develop；

**发布时间**

- 每周二外放灰度版本
- 每周三、周四定版正式版本

**bug修复**

- 特征：功能发布上线，通过反馈或者监控发现的问题，但严重性没有达到需要发版修复的程度
- 正式包的回归bug继续在 release分支修复，比如 release/2.2.0
- 灰度包的bug也是在 bugfix分支修复，比如 bugfix/2.2.0
- QA 测试无问题再合并回develop

**hotfix**

- 特征：功能发布上线，出现严重问题，需要进行线上热修复
- 解决方案：android基于发布版本进行修复，并导出patch，发布上线修复

**紧急需求**

- 特点：需要短时间内发布上线的需求，此需求的实现跨过灰度流程直接发布，并且在正式版本进行上线
- 解决方案：开发完成后，同步给release的同时，也同步给develop，避免出现功能的版本跳跃

**回炉重造**

- 特点：一个已经在灰度的问题，需要回滚，不在正式版上线，但又继续在后续的版本灰度。正式版本和灰度版本有先后顺序，需要执行回滚操作。
- 解决方案：基于功能分支拉出回滚分支，按提交逐个回滚，并且经过QA测试验收后，将分支合并给release进行正式版发布，同时同步给develop，再拉出分支进行pick回。

***发版时间示例***
![b897288986a6971e303c37175b718490.jpg](http://pfp.ps.netease.com/kmpvt/file/5f0efc918c56743e1f179459krvU8E6b01?sign=7Q8he5_k-CHFNGHRsB_oWwz-5u4=&expire=1598585342)

***GitFlow分支管理时序图***
![branch_final.png](http://pfp.ps.netease.com/kmpvt/file/5f4756976158bcf4103ae2b0Smexq9aC01?sign=XrFY3EPcFg2IdKQ-uid4onmgQVg=&expire=1598585342)